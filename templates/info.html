{% extends "dashboard/base.html" %}
{% load static %}

{% block content %}

    <style>
        /* Estilos optimizados */
        .status-badge, .priority-badge {
            font-size: 0.6875rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-weight: 500;
            display: inline-block;
        }

        .task-card {
            transition: all 0.2s ease;
            cursor: pointer;
            background-color: white;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.75rem;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .kanban-column {
            min-height: 400px;
            max-height: 80vh;
            width: 240px;
            flex-shrink: 0;
            overflow-y: auto;
        }

        .gantt-chart {
            height: 400px;
            min-width: 800px;
            overflow-x: auto;
        }

        .gantt-row {
            height: 50px;
            display: flex;
            align-items: center;
        }

        .gantt-bar {
            height: 20px;
            border-radius: 4px;
            margin-top: 5px;
        }

        .calendar-view {
            min-height: 600px;
        }

        .fc {
            font-family: inherit;
        }

        .fc-header-toolbar {
            padding: 10px;
            background-color: #f9fafb;
            border-radius: 8px 8px 0 0;
        }

        .fc-button {
            background-color: #3b82f6 !important;
            border: none !important;
            color: white !important;
        }

        /* Colores para estados */
        .status-pendiente { background-color: #9CA3AF; color: white; }
        .status-en_progreso { background-color: #3B82F6; color: white; }
        .status-completada { background-color: #10B981; color: white; }
        .status-rechazada { background-color: #EF4444; color: white; }
        .status-aprobada { background-color: #8B5CF6; color: white; }

        /* Colores para prioridades */
        .priority-baja { background-color: #10B981; color: white; }
        .priority-media { background-color: #F59E0B; color: white; }
        .priority-alta { background-color: #F97316; color: white; }
        .priority-urgente { background-color: #EF4444; color: white; }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-container {
            width: 100%;
            max-width: 28rem;
            margin: 0 1rem;
        }

        /* Form styles */
        .form-input {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            font-size: 0.875rem;
            line-height: 1.25rem;
            transition: all 0.2s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* Loading spinner */
        .spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Hidden utility class */
        .hidden {
            display: none;
        }
    </style>


    <!-- CDN Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script>
        // App State
        const state = {
            activeSection: 'tabla',
            currentProjectId: {{ proyecto.id }},
            calendar: null,
            isLoading: false,
            allTasks: []
        };

        // DOM Elements
        const elements = {
            sections: {
                tabla: document.getElementById('tabla-section'),
                kanban: document.getElementById('kanban-section'),
                gantt: document.getElementById('gantt-section'),
                grafico: document.getElementById('grafico-section'),
                calendario: document.getElementById('calendario-section')
            },
            modals: {
                task: {
                    overlay: document.getElementById('task-modal'),
                    form: document.getElementById('task-form'),
                    title: document.getElementById('task-modal-title')
                },
                taskDetails: {
                    overlay: document.getElementById('task-details-modal'),
                    name: document.getElementById('task-details-name'),
                    description: document.getElementById('task-details-description'),
                    status: document.getElementById('task-details-status'),
                    priority: document.getElementById('task-details-priority'),
                    assignee: document.getElementById('task-details-assignee'),
                    dueDate: document.getElementById('task-details-due-date'),
                    created: document.getElementById('task-details-created'),
                    documentsList: document.getElementById('task-documents-list'),
                    commentsList: document.getElementById('task-comments-list')
                }
            },
            forms: {
                document: document.getElementById('document-form'),
                comment: document.getElementById('comment-form')
            },
            charts: {
                status: null,
                priority: null
            },
            filters: {
                search: document.getElementById('search-input'),
                status: document.getElementById('status-filter'),
                priority: document.getElementById('priority-filter')
            }
        };

        // Utility Functions
        const utils = {
            getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            },

            showLoading() {
                state.isLoading = true;
                // Implement loading indicator
            },

            hideLoading() {
                state.isLoading = false;
                // Hide loading indicator
            },

            showAlert(message, type = 'success') {
                // Implement a nice alert system
                alert(message);
            },

            formatDate(dateString) {
                if (!dateString) return 'Sin fecha';
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return new Date(dateString).toLocaleDateString(undefined, options);
            },

            formatDateTime(dateString) {
                if (!dateString) return 'Sin fecha';
                const options = {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                };
                return new Date(dateString).toLocaleDateString(undefined, options);
            },

            closeModal(modalType) {
                if (elements.modals[modalType] && elements.modals[modalType].overlay) {
                    elements.modals[modalType].overlay.classList.remove('active');
                }
            },

            filterTasks(tasks) {
                const searchTerm = elements.filters.search ? elements.filters.search.value.toLowerCase() : '';
                const statusFilter = elements.filters.status ? elements.filters.status.value : '';
                const priorityFilter = elements.filters.priority ? elements.filters.priority.value : '';

                return tasks.filter(task => {
                    const matchesSearch = task.titulo.toLowerCase().includes(searchTerm) ||
                                        (task.descripcion && task.descripcion.toLowerCase().includes(searchTerm));
                    const matchesStatus = !statusFilter || task.estado === statusFilter;
                    const matchesPriority = !priorityFilter || task.prioridad === priorityFilter;

                    return matchesSearch && matchesStatus && matchesPriority;
                });
            }
        };

        // API Service
        const api = {
            async request(url, method = 'GET', data = null) {
                const headers = {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': utils.getCookie('csrftoken')
                };

                const config = {
                    method,
                    headers,
                    credentials: 'include'
                };

                if (data) {
                    config.body = JSON.stringify(data);
                }

                try {
                    utils.showLoading();
                    const response = await fetch(url, config);

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('API Error:', error);
                    throw error;
                } finally {
                    utils.hideLoading();
                }
            },

            getTasks(projectId) {
                return this.request(`/api/proyecto/${projectId}/tareas/`);
            },

            getTask(taskId) {
                return this.request(`/api/tarea/${taskId}/`);
            },

            createTask(data) {
                return this.request('/api/tarea/', 'POST', data);
            },

            updateTask(taskId, data) {
                return this.request(`/api/tarea/${taskId}/editar/`, 'PUT', data);
            },

            deleteTask(taskId) {
                return this.request(`/api/tarea/${taskId}/eliminar/`, 'DELETE');
            },

            addComment(taskId, content) {
                return this.request(`/api/tarea/${taskId}/comentarios/`, 'POST', { contenido: content });
            },

            uploadDocument(taskId, formData) {
                const headers = {
                    'X-CSRFToken': utils.getCookie('csrftoken')
                };

                return fetch(`/api/tarea/${taskId}/documentos/`, {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: formData
                }).then(response => response.json());
            }
        };

        // View Functions
        const views = {
            init() {
                // Initialize elements if they exist
                this.initElements();

                if (elements.sections.tabla) {
                    this.initCalendar();
                    this.initCharts();
                    this.loadTasks();
                    this.setupEventListeners();
                    this.changeSection('tabla');
                }
            },

            initElements() {
                // Initialize all elements to prevent null reference errors
                if (!elements.sections.tabla) elements.sections.tabla = document.getElementById('tabla-section');
                if (!elements.sections.kanban) elements.sections.kanban = document.getElementById('kanban-section');
                if (!elements.sections.gantt) elements.sections.gantt = document.getElementById('gantt-section');
                if (!elements.sections.grafico) elements.sections.grafico = document.getElementById('grafico-section');
                if (!elements.sections.calendario) elements.sections.calendario = document.getElementById('calendario-section');

                if (!elements.modals.task.overlay) elements.modals.task.overlay = document.getElementById('task-modal');
                if (!elements.modals.task.form) elements.modals.task.form = document.getElementById('task-form');
                if (!elements.modals.task.title) elements.modals.task.title = document.getElementById('task-modal-title');

                if (!elements.modals.taskDetails.overlay) elements.modals.taskDetails.overlay = document.getElementById('task-details-modal');
                if (!elements.modals.taskDetails.name) elements.modals.taskDetails.name = document.getElementById('task-details-name');
                if (!elements.modals.taskDetails.description) elements.modals.taskDetails.description = document.getElementById('task-details-description');
                if (!elements.modals.taskDetails.status) elements.modals.taskDetails.status = document.getElementById('task-details-status');
                if (!elements.modals.taskDetails.priority) elements.modals.taskDetails.priority = document.getElementById('task-details-priority');
                if (!elements.modals.taskDetails.assignee) elements.modals.taskDetails.assignee = document.getElementById('task-details-assignee');
                if (!elements.modals.taskDetails.dueDate) elements.modals.taskDetails.dueDate = document.getElementById('task-details-due-date');
                if (!elements.modals.taskDetails.created) elements.modals.taskDetails.created = document.getElementById('task-details-created');
                if (!elements.modals.taskDetails.documentsList) elements.modals.taskDetails.documentsList = document.getElementById('task-documents-list');
                if (!elements.modals.taskDetails.commentsList) elements.modals.taskDetails.commentsList = document.getElementById('task-comments-list');

                if (!elements.forms.document) elements.forms.document = document.getElementById('document-form');
                if (!elements.forms.comment) elements.forms.comment = document.getElementById('comment-form');

                if (!elements.filters.search) elements.filters.search = document.getElementById('search-input');
                if (!elements.filters.status) elements.filters.status = document.getElementById('status-filter');
                if (!elements.filters.priority) elements.filters.priority = document.getElementById('priority-filter');
            },

            setupEventListeners() {
                // Navigation links
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.changeSection(link.dataset.section);
                    });
                });

                // Edit task button in details modal
                const editTaskBtn = document.getElementById('edit-task-btn');
                if (editTaskBtn) {
                    editTaskBtn.addEventListener('click', () => {
                        const taskId = elements.modals.taskDetails.overlay.dataset.taskId;
                        this.showEditTaskModal(taskId);
                        utils.closeModal('taskDetails');
                    });
                }

                // Form submissions
                if (elements.modals.task.form) {
                    elements.modals.task.form.addEventListener('submit', (e) => this.handleTaskFormSubmit(e));
                }

                if (elements.forms.comment) {
                    elements.forms.comment.addEventListener('submit', (e) => this.handleCommentSubmit(e));
                }

                if (elements.forms.document) {
                    elements.forms.document.addEventListener('submit', (e) => this.handleDocumentSubmit(e));
                }

                // Filter events
                if (elements.filters.search) {
                    elements.filters.search.addEventListener('input', () => this.applyFilters());
                }

                if (elements.filters.status) {
                    elements.filters.status.addEventListener('change', () => this.applyFilters());
                }

                if (elements.filters.priority) {
                    elements.filters.priority.addEventListener('change', () => this.applyFilters());
                }
            },

            applyFilters() {
                const filteredTasks = utils.filterTasks(state.allTasks);
                this.updateViews(filteredTasks);
            },

            updateViews(tasks) {
                this.updateTaskTable(tasks);
                this.updateKanbanBoard(tasks);
                this.updateCharts(tasks);
                this.updateCalendar(tasks);
                this.updateGanttChart(tasks);
            },

            changeSection(section) {
                state.activeSection = section;

                // Hide all sections
                Object.values(elements.sections).forEach(sectionEl => {
                    if (sectionEl) sectionEl.classList.add('hidden');
                });

                // Show active section
                if (elements.sections[section]) {
                    elements.sections[section].classList.remove('hidden');
                }

                // Update navigation
                this.updateNavLinks();

                // Special handling for calendar
                if (section === 'calendario' && state.calendar) {
                    state.calendar.render();
                }
            },

            updateNavLinks() {
                document.querySelectorAll('.nav-link').forEach(link => {
                    if (link.getAttribute('data-section') === state.activeSection) {
                        link.classList.add('text-blue-600', 'border-b-2', 'border-blue-600');
                        link.classList.remove('text-gray-500');
                    } else {
                        link.classList.remove('text-blue-600', 'border-b-2', 'border-blue-600');
                        link.classList.add('text-gray-500');
                    }
                });
            },

            initCalendar() {
                const calendarEl = document.getElementById('calendar');
                if (calendarEl) {
                    state.calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,timeGridWeek,timeGridDay'
                        },
                        themeSystem: 'standard',
                        events: [],
                        eventClick: (info) => {
                            this.showTaskDetailsModal(info.event.extendedProps.taskId);
                        },
                        eventBackgroundColor: '#3B82F6',
                        eventBorderColor: '#2563EB',
                        eventTextColor: '#FFFFFF'
                    });
                }
            },

            initCharts() {
                // Status Chart
                const statusCtx = document.getElementById('statusChart');
                if (statusCtx) {
                    elements.charts.status = new Chart(statusCtx.getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Pendientes', 'En Progreso', 'Completadas', 'Rechazadas', 'Aprobadas'],
                            datasets: [{
                                data: [0, 0, 0, 0, 0],
                                backgroundColor: [
                                    '#9CA3AF', // Pendientes - gris
                                    '#3B82F6', // En progreso - azul
                                    '#10B981', // Completadas - verde
                                    '#EF4444', // Rechazadas - rojo
                                    '#8B5CF6'  // Aprobadas - violeta
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    position: 'right',
                                }
                            }
                        }
                    });
                }

                // Priority Chart
                const priorityCtx = document.getElementById('priorityChart');
                if (priorityCtx) {
                    elements.charts.priority = new Chart(priorityCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Baja', 'Media', 'Alta', 'Urgente'],
                            datasets: [{
                                label: 'Tareas por Prioridad',
                                data: [0, 0, 0, 0],
                                backgroundColor: [
                                    '#10B981', // Baja - verde
                                    '#F59E0B', // Media - amarillo
                                    '#F97316', // Alta - naranja
                                    '#EF4444'  // Urgente - rojo
                                ],
                                borderColor: [
                                    '#047857',
                                    '#B45309',
                                    '#C2410C',
                                    '#B91C1C'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            },

            async loadTasks() {
                try {
                    const tasks = await api.getTasks(state.currentProjectId);
                    state.allTasks = tasks;
                    this.applyFilters();
                } catch (error) {
                    utils.showAlert('Error al cargar las tareas', 'error');
                }
            },

            updateTaskTable(tasks) {
                const tbody = document.getElementById('tasks-table-body');
                if (!tbody) return;

                tbody.innerHTML = '';

                tasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="py-3 px-4">
                            <button onclick="views.showTaskDetailsModal(${task.id})" class="text-blue-500 hover:text-blue-700 mr-2">
                                <i class="fas fa-eye text-gray-400"></i>
                            </button>
                            ${task.titulo}
                        </td>
                        <td class="py-3 px-4">
                            ${task.asignado_a ? task.asignado_a.nombre_completo : 'Sin asignar'}
                        </td>
                        <td class="py-3 px-4">
                            <span class="status-badge status-${task.estado}">${task.get_estado_display}</span>
                        </td>
                        <td class="py-3 px-4">
                            <span class="priority-badge priority-${task.prioridad}">${task.get_prioridad_display}</span>
                        </td>
                        <td class="py-3 px-4">
                            ${utils.formatDate(task.fecha_tope)}
                        </td>
                        <td class="py-3 px-4 text-right">
                            <div class="flex justify-end space-x-2">
                                <button onclick="views.showEditTaskModal(${task.id})" class="text-blue-500 hover:text-blue-700">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="views.confirmDeleteTask(${task.id})" class="text-red-500 hover:text-red-700">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                // Add row for new task
                const addRow = document.createElement('tr');
                addRow.className = 'hover:bg-gray-50';
                addRow.innerHTML = `
                    <td colspan="6" class="py-2 px-4">
                        <button onclick="views.showAddTaskModal()" class="text-blue-500 hover:text-blue-700">
                            + Agregar nueva tarea
                        </button>
                    </td>
                `;
                tbody.appendChild(addRow);
            },

            updateKanbanBoard(tasks) {
                const statuses = {
                    'pendiente': document.getElementById('kanban-pendiente'),
                    'en_progreso': document.getElementById('kanban-en_progreso'),
                    'completada': document.getElementById('kanban-completada'),
                    'rechazada': document.getElementById('kanban-rechazada'),
                    'aprobada': document.getElementById('kanban-aprobada')
                };

                // Clear columns
                Object.values(statuses).forEach(column => {
                    if (column) {
                        const tasksContainer = column.querySelector('.kanban-tasks');
                        if (tasksContainer) tasksContainer.innerHTML = '';
                    }
                });

                // Add tasks to columns
                tasks.forEach(task => {
                    const column = statuses[task.estado];
                    if (column) {
                        const tasksContainer = column.querySelector('.kanban-tasks');
                        if (tasksContainer) {
                            const taskCard = document.createElement('div');
                            taskCard.className = 'task-card';
                            taskCard.setAttribute('draggable', 'true');
                            taskCard.dataset.taskId = task.id;
                            taskCard.innerHTML = `
                                <h3 class="text-sm font-medium text-gray-800">${task.titulo}</h3>
                                <div class="flex items-center justify-between mt-2">
                                    <span class="priority-badge priority-${task.prioridad}">${task.get_prioridad_display}</span>
                                    <span class="text-xs text-gray-500">${utils.formatDate(task.fecha_tope)}</span>
                                </div>
                            `;
                            taskCard.addEventListener('click', () => this.showTaskDetailsModal(task.id));
                            tasksContainer.appendChild(taskCard);
                        }
                    }
                });

                // Add "Add task" button to each column
                Object.values(statuses).forEach(column => {
                    if (column) {
                        const tasksContainer = column.querySelector('.kanban-tasks');
                        if (tasksContainer) {
                            const addButton = document.createElement('button');
                            addButton.className = 'text-gray-500 hover:text-gray-700 text-sm w-full text-left py-1 px-2 rounded hover:bg-gray-100';
                            addButton.innerHTML = '+ Agregar tarea';
                            addButton.addEventListener('click', () => {
                                this.showAddTaskModal(column.dataset.status);
                            });
                            tasksContainer.appendChild(addButton);
                        }
                    }
                });

                this.setupDragAndDrop();
            },

            setupDragAndDrop() {
                // Implement drag and drop functionality
                const draggables = document.querySelectorAll('.task-card');
                const containers = document.querySelectorAll('.kanban-tasks');

                draggables.forEach(draggable => {
                    draggable.addEventListener('dragstart', () => {
                        draggable.classList.add('dragging');
                    });

                    draggable.addEventListener('dragend', () => {
                        draggable.classList.remove('dragging');
                    });
                });

                containers.forEach(container => {
                    container.addEventListener('dragover', e => {
                        e.preventDefault();
                        const afterElement = this.getDragAfterElement(container, e.clientY);
                        const draggable = document.querySelector('.dragging');
                        if (draggable) {
                            if (afterElement == null) {
                                container.appendChild(draggable);
                            } else {
                                container.insertBefore(draggable, afterElement);
                            }
                        }
                    });
                });
            },

            getDragAfterElement(container, y) {
                const draggableElements = [...container.querySelectorAll('.task-card:not(.dragging)')];

                return draggableElements.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    if (offset < 0 && offset > closest.offset) {
                        return { offset: offset, element: child };
                    } else {
                        return closest;
                    }
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            },

            updateCharts(tasks) {
                // Count tasks by status
                const statusCounts = {
                    'pendiente': 0,
                    'en_progreso': 0,
                    'completada': 0,
                    'rechazada': 0,
                    'aprobada': 0
                };

                tasks.forEach(task => {
                    statusCounts[task.estado]++;
                });

                // Update status chart
                if (elements.charts.status) {
                    elements.charts.status.data.datasets[0].data = Object.values(statusCounts);
                    elements.charts.status.update();
                }

                // Count tasks by priority
                const priorityCounts = {
                    'baja': 0,
                    'media': 0,
                    'alta': 0,
                    'urgente': 0
                };

                tasks.forEach(task => {
                    priorityCounts[task.prioridad]++;
                });

                // Update priority chart
                if (elements.charts.priority) {
                    elements.charts.priority.data.datasets[0].data = Object.values(priorityCounts);
                    elements.charts.priority.update();
                }
            },

            updateCalendar(tasks) {
                if (!state.calendar) return;

                const events = tasks.map(task => ({
                    title: task.titulo,
                    start: task.fecha_tope,
                    extendedProps: {
                        taskId: task.id
                    },
                    backgroundColor: this.getStatusColor(task.estado),
                    borderColor: this.getStatusColor(task.estado)
                }));

                state.calendar.removeAllEvents();
                state.calendar.addEventSource(events);
            },

            updateGanttChart(tasks) {
                const ganttContainer = document.getElementById('gantt-chart');
                if (!ganttContainer) return;

                ganttContainer.innerHTML = '';

                // Get min and max dates for scaling
                const dates = tasks
                    .filter(task => task.fecha_creacion && task.fecha_tope)
                    .map(task => ({
                        start: new Date(task.fecha_creacion),
                        end: new Date(task.fecha_tope)
                    }));

                const minDate = dates.length > 0 ?
                    new Date(Math.min(...dates.map(d => d.start))) :
                    new Date();
                const maxDate = dates.length > 0 ?
                    new Date(Math.max(...dates.map(d => d.end))) :
                    new Date(new Date().setMonth(new Date().getMonth() + 1));

                const totalDays = (maxDate - minDate) / (1000 * 60 * 60 * 24);

                const ganttHTML = `
                    <div class="gantt-header flex border-b">
                        <div class="w-48 px-4 py-2 font-medium">Tarea</div>
                        <div class="flex-1 px-4 py-2 font-medium">Timeline</div>
                    </div>
                    ${tasks.map(task => {
                        const startDate = task.fecha_creacion ? new Date(task.fecha_creacion) : minDate;
                        const endDate = task.fecha_tope ? new Date(task.fecha_tope) : maxDate;

                        const startOffset = ((startDate - minDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;
                        const duration = ((endDate - startDate) / (1000 * 60 * 60 * 24)) / totalDays * 100;

                        return `
                        <div class="gantt-row">
                            <div class="w-48 px-4 py-3">${task.titulo}</div>
                            <div class="flex-1 px-4 py-3 relative h-8">
                                <div class="gantt-bar ${this.getStatusClass(task.estado)}"
                                     style="left: ${Math.max(0, startOffset)}%;
                                            width: ${Math.min(100, duration)}%;">
                                    <span class="text-xs absolute left-0 -bottom-5 whitespace-nowrap">${utils.formatDate(task.fecha_creacion)}</span>
                                    <span class="text-xs absolute right-0 -bottom-5 whitespace-nowrap">${utils.formatDate(task.fecha_tope)}</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                `;

                ganttContainer.innerHTML = ganttHTML;
            },

            getStatusColor(status) {
                const colors = {
                    'pendiente': '#9CA3AF',
                    'en_progreso': '#3B82F6',
                    'completada': '#10B981',
                    'rechazada': '#EF4444',
                    'aprobada': '#8B5CF6'
                };
                return colors[status] || '#9CA3AF';
            },

            getStatusClass(status) {
                return `status-${status}`;
            },

            async showTaskDetailsModal(taskId) {
                try {
                    const task = await api.getTask(taskId);

                    // Store task ID in modal
                    if (elements.modals.taskDetails.overlay) {
                        elements.modals.taskDetails.overlay.dataset.taskId = task.id;
                    }

                    // Update modal content
                    if (elements.modals.taskDetails.name) elements.modals.taskDetails.name.textContent = task.titulo;
                    if (elements.modals.taskDetails.description) elements.modals.taskDetails.description.textContent = task.descripcion || 'Sin descripción';
                    if (elements.modals.taskDetails.status) {
                        elements.modals.taskDetails.status.textContent = task.get_estado_display;
                        elements.modals.taskDetails.status.className = `status-badge status-${task.estado}`;
                    }
                    if (elements.modals.taskDetails.priority) {
                        elements.modals.taskDetails.priority.textContent = task.get_prioridad_display;
                        elements.modals.taskDetails.priority.className = `priority-badge priority-${task.prioridad}`;
                    }
                    if (elements.modals.taskDetails.assignee) elements.modals.taskDetails.assignee.textContent = task.asignado_a ? task.asignado_a.nombre_completo : 'Sin asignar';
                    if (elements.modals.taskDetails.dueDate) elements.modals.taskDetails.dueDate.textContent = utils.formatDate(task.fecha_tope);
                    if (elements.modals.taskDetails.created) elements.modals.taskDetails.created.textContent = utils.formatDate(task.fecha_creacion);

                    // Show documents
                    if (elements.modals.taskDetails.documentsList) {
                        elements.modals.taskDetails.documentsList.innerHTML = task.documentos && task.documentos.length > 0 ?
                            task.documentos.map(doc => `
                                <li class="flex items-center justify-between py-2 px-3 hover:bg-gray-50 rounded">
                                    <div class="flex items-center">
                                        <i class="fas fa-file-alt text-gray-400 mr-2"></i>
                                        <span>${doc.nombre}</span>
                                    </div>
                                    <a href="${doc.archivo}" download class="text-blue-500 hover:text-blue-700">
                                        <i class="fas fa-download"></i>
                                    </a>
                                </li>
                            `).join('') : '<li class="text-sm text-gray-500 py-2 px-3">No hay documentos adjuntos</li>';
                    }

                    // Show comments
                    if (elements.modals.taskDetails.commentsList) {
                        elements.modals.taskDetails.commentsList.innerHTML = task.comentarios && task.comentarios.length > 0 ?
                            task.comentarios.map(comment => `
                                <div class="border-b pb-3 mb-3">
                                    <div class="flex justify-between items-start mb-1">
                                        <div class="font-medium">${comment.usuario.nombre_completo}</div>
                                        <div class="text-xs text-gray-500">${utils.formatDateTime(comment.fecha_creacion)}</div>
                                    </div>
                                    <div class="text-sm">${comment.contenido}</div>
                                    ${comment.archivos && comment.archivos.length > 0 ?
                                        comment.archivos.map(archivo => `
                                            <div class="mt-2 flex items-center">
                                                <i class="fas fa-paperclip text-gray-400 mr-2"></i>
                                                <a href="${archivo.archivo}" download class="text-blue-500 hover:text-blue-700 text-sm">
                                                    ${archivo.nombre}
                                                </a>
                                            </div>
                                        `).join('') : ''
                                    }
                                </div>
                            `).join('') : '<div class="text-sm text-gray-500">No hay comentarios</div>';
                    }

                    // Show modal
                    if (elements.modals.taskDetails.overlay) {
                        elements.modals.taskDetails.overlay.classList.add('active');
                    }
                } catch (error) {
                    utils.showAlert('Error al cargar los detalles de la tarea', 'error');
                }
            },

            showAddTaskModal(defaultStatus = null) {
                if (!elements.modals.task.overlay) return;

                // Reset form
                elements.modals.task.form.reset();
                elements.modals.task.form.dataset.taskId = '';
                if (elements.modals.task.title) {
                    elements.modals.task.title.textContent = 'Agregar Nueva Tarea';
                }

                // Set default status if provided
                if (defaultStatus) {
                    const statusField = document.getElementById('id_estado');
                    if (statusField) statusField.value = defaultStatus;
                }

                // Set project ID
                const projectField = document.getElementById('id_proyecto');
                if (projectField) projectField.value = state.currentProjectId;

                // Show modal
                elements.modals.task.overlay.classList.add('active');
            },

            showEditTaskModal(taskId) {
                this.showAddTaskModal(); // Reuse the add modal
                if (elements.modals.task.title) {
                    elements.modals.task.title.textContent = 'Editar Tarea';
                }

                api.getTask(taskId)
                    .then(task => {
                        if (elements.modals.task.form) {
                            elements.modals.task.form.dataset.taskId = task.id;

                            const titleField = document.getElementById('id_titulo');
                            if (titleField) titleField.value = task.titulo;

                            const descField = document.getElementById('id_descripcion');
                            if (descField) descField.value = task.descripcion;

                            const priorityField = document.getElementById('id_prioridad');
                            if (priorityField) priorityField.value = task.prioridad;

                            const statusField = document.getElementById('id_estado');
                            if (statusField) statusField.value = task.estado;

                            const assigneeField = document.getElementById('id_asignado_a');
                            if (assigneeField) assigneeField.value = task.asignado_a ? task.asignado_a.id : '';

                            const dueDateField = document.getElementById('id_fecha_tope');
                            if (dueDateField && task.fecha_tope) {
                                const date = new Date(task.fecha_tope);
                                const formattedDate = date.toISOString().slice(0, 16);
                                dueDateField.value = formattedDate;
                            }
                        }
                    })
                    .catch(error => {
                        utils.showAlert('Error al cargar la tarea para editar', 'error');
                    });
            },

            async handleTaskFormSubmit(event) {
                event.preventDefault();

                if (!elements.modals.task.form) return;

                const form = event.target;
                const formData = new FormData(form);
                const taskId = form.dataset.taskId;

                // Convert FormData to object
                const data = {};
                formData.forEach((value, key) => data[key] = value);

                try {
                    let response;
                    if (taskId) {
                        response = await api.updateTask(taskId, data);
                    } else {
                        response = await api.createTask(data);
                    }

                    if (response.success) {
                        utils.closeModal('task');
                        this.loadTasks();
                        utils.showAlert(taskId ? 'Tarea actualizada correctamente' : 'Tarea creada correctamente');
                    } else {
                        utils.showAlert(Object.values(response.errors).join(', '), 'error');
                    }
                } catch (error) {
                    utils.showAlert('Error al guardar la tarea', 'error');
                }
            },

            confirmDeleteTask(taskId) {
                if (confirm('¿Estás seguro de que deseas eliminar esta tarea?')) {
                    this.deleteTask(taskId);
                }
            },

            async deleteTask(taskId) {
                try {
                    const response = await api.deleteTask(taskId);
                    if (response.success) {
                        this.loadTasks();
                        utils.showAlert('Tarea eliminada correctamente');
                    } else {
                        utils.showAlert('Error al eliminar la tarea', 'error');
                    }
                } catch (error) {
                    utils.showAlert('Error al eliminar la tarea', 'error');
                }
            },

            async handleCommentSubmit(event) {
                event.preventDefault();

                if (!elements.forms.comment || !elements.modals.taskDetails.overlay) return;

                const form = event.target;
                const formData = new FormData(form);
                const taskId = elements.modals.taskDetails.overlay.dataset.taskId;
                const content = formData.get('contenido');

                try {
                    const response = await api.addComment(taskId, content);
                    if (response.success) {
                        form.reset();
                        this.showTaskDetailsModal(taskId); // Refresh details
                    } else {
                        utils.showAlert(Object.values(response.errors).join(', '), 'error');
                    }
                } catch (error) {
                    utils.showAlert('Error al agregar el comentario', 'error');
                }
            },

            async handleDocumentSubmit(event) {
                event.preventDefault();

                if (!elements.forms.document || !elements.modals.taskDetails.overlay) return;

                const form = event.target;
                const formData = new FormData(form);
                const taskId = elements.modals.taskDetails.overlay.dataset.taskId;

                try {
                    const response = await api.uploadDocument(taskId, formData);
                    if (response.success) {
                        form.reset();
                        this.showTaskDetailsModal(taskId); // Refresh details
                    } else {
                        utils.showAlert(Object.values(response.errors).join(', '), 'error');
                    }
                } catch (error) {
                    utils.showAlert('Error al subir el documento', 'error');
                }
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', () => {
            views.init();
        });
    </script>
<main class="font-sans">
    <!-- Main Content -->
    <div class="px-4 py-2">
        <!-- Project Header -->
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-semibold text-gray-800">{{ proyecto.nombre }} - Gestión de Tareas</h1>
            <div class="flex items-center space-x-2">
                <div class="bg-yellow-500 text-white rounded-full w-7 h-7 flex items-center justify-center text-sm">
                    <i class="fas fa-users"></i>
                </div>
                <span class="text-sm">Miembros: {{ proyecto.integrantes.count }}</span>
            </div>
        </div>

        <!-- Navigation -->
        <div class="flex space-x-6 mb-4 border-b border-gray-200 pb-1">
            <a href="#" class="nav-link text-gray-500" data-section="tabla">Tabla principal</a>
            <a href="#" class="nav-link text-gray-500" data-section="kanban">Kanban</a>
            <a href="#" class="nav-link text-gray-500" data-section="gantt">Gantt</a>
            <a href="#" class="nav-link text-gray-500" data-section="grafico">Gráfico</a>
            <a href="#" class="nav-link text-gray-500" data-section="calendario">Calendario</a>
        </div>

        <!-- Table Section -->
        <div id="tabla-section" class="mb-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-3">
                    <button onclick="views.showAddTaskModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">
                        Agregar tarea
                    </button>

                    <div class="relative">
                        <input type="text" placeholder="Buscar..." id="search-input"
                               class="w-48 pl-8 pr-3 py-1.5 border rounded-full text-sm focus:ring-1 focus:ring-blue-500">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                    </div>

                    <div class="relative">
                        <select id="status-filter" class="w-40 pl-8 pr-3 py-1.5 border rounded-full text-sm focus:ring-1 focus:ring-blue-500">
                            <option value="">Todos los estados</option>
                            {% for value, label in Tarea.ESTADOS_TAREA %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="relative">
                        <select id="priority-filter" class="w-40 pl-8 pr-3 py-1.5 border rounded-full text-sm focus:ring-1 focus:ring-blue-500">
                            <option value="">Todas las prioridades</option>
                            {% for value, label in Tarea.PRIORIDADES %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tarea</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Asignado a</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Prioridad</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha límite</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tasks-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Tasks will be loaded here dynamically -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Kanban Section -->
        <div id="kanban-section" class="hidden mb-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-3">
                    <button onclick="views.showAddTaskModal()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700">
                        Agregar tarea
                    </button>
                </div>
            </div>

            <div class="flex space-x-4 overflow-x-auto pb-4">
                <!-- Pending Column -->
                <div id="kanban-pendiente" data-status="pendiente" class="kanban-column bg-gray-50 rounded-lg border border-gray-200 p-3">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-sm font-semibold text-gray-700 flex items-center">
                            <span class="bg-gray-200 text-gray-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2" id="pendiente-count">0</span>
                            Pendiente
                        </h2>
                        <button class="text-gray-600 hover:text-gray-800 text-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="kanban-tasks">
                        <!-- Tasks will be loaded here dynamically -->
                    </div>
                </div>

                <!-- In Progress Column -->
                <div id="kanban-en_progreso" data-status="en_progreso" class="kanban-column bg-blue-50 rounded-lg border border-blue-200 p-3">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-sm font-semibold text-blue-700 flex items-center">
                            <span class="bg-blue-200 text-blue-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2" id="en_progreso-count">0</span>
                            En Progreso
                        </h2>
                        <button class="text-blue-600 hover:text-blue-800 text-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="kanban-tasks">
                        <!-- Tasks will be loaded here dynamically -->
                    </div>
                </div>

                <!-- Completed Column -->
                <div id="kanban-completada" data-status="completada" class="kanban-column bg-green-50 rounded-lg border border-green-200 p-3">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-sm font-semibold text-green-700 flex items-center">
                            <span class="bg-green-200 text-green-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2" id="completada-count">0</span>
                            Completada
                        </h2>
                        <button class="text-green-600 hover:text-green-800 text-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="kanban-tasks">
                        <!-- Tasks will be loaded here dynamically -->
                    </div>
                </div>

                <!-- Rejected Column -->
                <div id="kanban-rechazada" data-status="rechazada" class="kanban-column bg-red-50 rounded-lg border border-red-200 p-3">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-sm font-semibold text-red-700 flex items-center">
                            <span class="bg-red-200 text-red-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2" id="rechazada-count">0</span>
                            Rechazada
                        </h2>
                        <button class="text-red-600 hover:text-red-800 text-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="kanban-tasks">
                        <!-- Tasks will be loaded here dynamically -->
                    </div>
                </div>

                <!-- Approved Column -->
                <div id="kanban-aprobada" data-status="aprobada" class="kanban-column bg-purple-50 rounded-lg border border-purple-200 p-3">
                    <div class="flex items-center justify-between mb-3">
                        <h2 class="text-sm font-semibold text-purple-700 flex items-center">
                            <span class="bg-purple-200 text-purple-700 rounded-full w-5 h-5 flex items-center justify-center text-xs mr-2" id="aprobada-count">0</span>
                            Aprobada
                        </h2>
                        <button class="text-purple-600 hover:text-purple-800 text-sm">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="kanban-tasks">
                        <!-- Tasks will be loaded here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Gantt Section -->
        <div id="gantt-section" class="hidden mb-4">
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Diagrama de Gantt</h2>
                <div class="overflow-x-auto">
                    <div id="gantt-chart" class="gantt-chart min-w-max">
                        <!-- Gantt chart will be generated here dynamically -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div id="grafico-section" class="hidden mb-4">
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Gráficos de Progreso</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white p-4 rounded border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Tareas por Estado</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="bg-white p-4 rounded border border-gray-200">
                        <h3 class="text-sm font-medium text-gray-700 mb-3">Tareas por Prioridad</h3>
                        <canvas id="priorityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Calendar Section -->
        <div id="calendario-section" class="hidden mb-4">
            <div class="bg-white rounded-lg border border-gray-200 p-4">
                <h2 class="text-lg font-semibold text-gray-800 mb-4">Calendario</h2>
                <div id="calendar" class="calendar-view"></div>
            </div>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="task-modal" class="modal-overlay">
        <div class="modal-container w-full max-w-md">
            <div class="relative bg-white rounded-xl shadow-2xl overflow-hidden">
                <div class="px-6 py-4 bg-gradient-to-r from-blue-600 to-blue-500">
                    <h2 class="text-xl font-semibold text-white" id="task-modal-title">Agregar Nueva Tarea</h2>
                    <button onclick="utils.closeModal('task')"
                            class="absolute top-4 right-4 text-white hover:text-blue-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <form id="task-form" class="px-6 py-5 space-y-5">
                    {% csrf_token %}
                    <input type="hidden" name="proyecto" id="id_proyecto" value="{{ proyecto }}">

                    <div class="space-y-5">
                        <!-- Title -->
                        <div>
                            <label for="id_titulo" class="block text-sm font-medium text-gray-700 mb-1.5">Título</label>
                            <input type="text" name="titulo" id="id_titulo" required class="form-input">
                        </div>

                        <!-- Description -->
                        <div>
                            <label for="id_descripcion" class="block text-sm font-medium text-gray-700 mb-1.5">Descripción</label>
                            <textarea name="descripcion" id="id_descripcion" rows="3" class="form-input"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Priority -->
                            <div>
                                <label for="id_prioridad" class="block text-sm font-medium text-gray-700 mb-1.5">Prioridad</label>
                                <select name="prioridad" id="id_prioridad" required class="form-input form-select">
    {% for value, label in prioridades %}
        <option value="{{ value }}">{{ label }}</option>
    {% endfor %}
</select>
                            </div>

                            <!-- Status -->
                            <div>
                                <label for="id_estado" class="block text-sm font-medium text-gray-700 mb-1.5">Estado</label>
                                <select name="estado" id="id_estado" required class="form-input form-select">
    {% for value, label in estados_tarea %}
        <option value="{{ value }}">{{ label }}</option>
    {% endfor %}
</select>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Assigned To -->
                            <div>
                                <label for="id_asignado_a" class="block text-sm font-medium text-gray-700 mb-1.5">Asignado a</label>
                                <select name="asignado_a" id="id_asignado_a" class="form-input form-select">
                                    <option value="">Seleccionar...</option>
                                    {% for usuario in proyecto.integrantes.all %}
                                        <option value="{{ usuario.id }}">{{ usuario.get_full_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>

                            <!-- Due Date -->
                            <div>
                                <label for="id_fecha_tope" class="block text-sm font-medium text-gray-700 mb-1.5">Fecha límite</label>
                                <input type="datetime-local" name="fecha_tope" id="id_fecha_tope" class="form-input">
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
                        <button type="button" onclick="utils.closeModal('task')"
                                class="px-5 py-2.5 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-200 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-5 py-2.5 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-300 transition-colors">
                            Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div id="task-details-modal" class="modal-overlay">
        <div class="bg-white rounded-lg border border-gray-200 p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-start mb-4">
                <h2 class="text-xl font-bold text-gray-800" id="task-details-name">Nombre de la tarea</h2>
                <button class="text-gray-500 hover:text-gray-700" onclick="utils.closeModal('taskDetails')">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <div class="mb-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Descripción</h3>
                        <p class="text-sm text-gray-800" id="task-details-description"></p>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-1">Estado</h3>
                            <span id="task-details-status" class="status-badge"></span>
                        </div>

                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-1">Prioridad</h3>
                            <span id="task-details-priority" class="priority-badge"></span>
                        </div>

                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-1">Asignado a</h3>
                            <p class="text-sm text-gray-800" id="task-details-assignee"></p>
                        </div>

                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-1">Fecha límite</h3>
                            <p class="text-sm text-gray-800" id="task-details-due-date"></p>
                        </div>

                        <div>
                            <h3 class="text-sm font-medium text-gray-700 mb-1">Creada</h3>
                            <p class="text-sm text-gray-800" id="task-details-created"></p>
                        </div>
                    </div>

                    <div class="mb-6">
                        <h3 class="text-sm font-medium text-gray-700 mb-2">Documentos adjuntos</h3>
                        <ul id="task-documents-list" class="border rounded divide-y divide-gray-200">
                            <!-- Documents will be loaded here dynamically -->
                        </ul>
                    </div>
                </div>

                <div>
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Comentarios</h3>
                    <div id="task-comments-list" class="mb-4 max-h-60 overflow-y-auto">
                        <!-- Comments will be loaded here dynamically -->
                    </div>
                </div>
            </div>

            <div class="flex justify-end space-x-3 mt-6">
                <button onclick="utils.closeModal('taskDetails')"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md text-sm hover:bg-gray-300">
                    Cerrar
                </button>

            </div>
        </div>
    </div>
</main>

{% endblock %}